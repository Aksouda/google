<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription - Google Reviews Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .current-plan {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .current-plan h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .plan-status {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .plan-status.free {
            background: #e9ecef;
            color: #495057;
        }
        
        .plan-status.premium {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .plan-status.enterprise {
            background: #d4edda;
            color: #155724;
        }
        
        .plan-status.cancelling {
            background: #fff3cd;
            color: #856404;
        }
        
        .plan-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .plan-status.active {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .billing-option {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .billing-option:hover {
            border-color: #4285f4;
            background: #f8f9fa;
        }
        
        .billing-option.active {
            border-color: #4285f4;
            background: #4285f4;
            color: white;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .pricing-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .pricing-card.popular {
            border-color: #4285f4;
            transform: scale(1.05);
        }
        
        .pricing-card.popular::before {
            content: 'Most Popular';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #4285f4;
            color: white;
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .plan-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .plan-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4285f4;
            margin-bottom: 5px;
        }
        
        .plan-period {
            color: #666;
            margin-bottom: 20px;
        }
        
        .plan-features {
            list-style: none;
            margin-bottom: 30px;
        }
        
        .plan-features li {
            padding: 8px 0;
            color: #555;
            position: relative;
        }
        
        .plan-features li::before {
            content: '‚úì';
            color: #28a745;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .plan-features li.unavailable {
            color: #999;
        }
        
        .plan-features li.unavailable::before {
            content: '‚úó';
            color: #dc3545;
        }
        
        .plan-button {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .plan-button.free {
            background: #6c757d;
            color: white;
        }
        
        .plan-button.premium {
            background: #4285f4;
            color: white;
        }
        
        .plan-button.enterprise {
            background: #28a745;
            color: white;
        }
        
        .plan-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .plan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-link {
            text-align: center;
            margin-top: 30px;
        }
        
        .back-link a {
            color: #4285f4;
            text-decoration: none;
            font-size: 1.1rem;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        .auth-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Choose Your Plan</h1>
            <p>Select the perfect plan for your business needs</p>
        </div>
        
        <div id="auth-warning" class="auth-warning" style="display: none;">
            <strong>Please log in to manage your subscription</strong>
            <br>
            <a href="/">Go to Login</a>
        </div>
        
        <div id="current-plan" class="current-plan" style="display: none;">
            <h3>Your Current Plan</h3>
            <div id="current-plan-status" class="plan-status free">FREE</div>
            <div id="current-plan-details"></div>
            <div id="subscription-actions" style="margin-top: 20px;">
                <button id="manage-subscription-btn" class="plan-button premium" style="display: none;">
                    Manage Subscription
                </button>
                <button id="cancel-subscription-btn" class="plan-button" style="background: #dc3545; display: none;">
                    Cancel Subscription
                </button>
                <button id="reactivate-subscription-btn" class="plan-button premium" style="display: none;">
                    Reactivate Subscription
                </button>
            </div>
        </div>
        
        
        <div class="back-link">
            <a href="/dashboard">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <script src="auth-utils.js"></script>
    <script>
        let currentUser = null;
        let subscriptionData = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîê Checking authentication for subscription page...');
            
            const authStatus = await authManager.checkBothAuth();
            
            if (!authStatus.app) {
                document.getElementById('auth-warning').style.display = 'block';
                return;
            }
            
            currentUser = authManager.appUser;
            
            // First try to load subscription data
            await loadSubscriptionData();
            
            // If we have a premium user but no subscription data, auto-sync
            if (currentUser.subscription_status === 'premium' && !subscriptionData) {
                console.log('üîÑ Auto-syncing subscription with Stripe...');
                await syncSubscription(false); // Don't show messages during auto-sync
            }
            
            updateCurrentPlanDisplay();
            setupEventListeners();
        });
        
        async function loadSubscriptionData() {
            try {
                const response = await authManager.apiRequest('/api/stripe/subscription', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    subscriptionData = data.subscription;
                    console.log('üìä Subscription data loaded:', subscriptionData);
                } else {
                    const error = await response.json();
                    console.error('Failed to load subscription data:', error);
                    
                    // If user has no Stripe subscription, that's okay
                    if (error.error === 'USER_NOT_FOUND' || error.error === 'NO_SUBSCRIPTION') {
                        subscriptionData = null;
                        console.log('‚ÑπÔ∏è No Stripe subscription found, using app subscription status');
                    }
                }
            } catch (error) {
                console.error('Error loading subscription data:', error);
                subscriptionData = null;
            }
        }

        function updateCurrentPlanDisplay() {
            if (!currentUser) return;
            
            const currentPlanDiv = document.getElementById('current-plan');
            const statusDiv = document.getElementById('current-plan-status');
            const detailsDiv = document.getElementById('current-plan-details');
            
            currentPlanDiv.style.display = 'block';
            
            // Determine plan status
            let planStatus = currentUser.subscription_status;
            let statusText = planStatus.toUpperCase();
            
            if (subscriptionData) {
                if (subscriptionData.cancel_at_period_end) {
                    statusText = 'CANCELLING';
                    planStatus = 'cancelling';
                } else if (subscriptionData.status === 'active') {
                    statusText = 'ACTIVE';
                } else if (subscriptionData.status === 'canceled') {
                    statusText = 'CANCELLED';
                    planStatus = 'cancelled';
                }
            }
            
            statusDiv.textContent = statusText;
            statusDiv.className = `plan-status ${planStatus}`;
            
            // Build details
            let details = `Member since ${new Date(currentUser.created_at).toLocaleDateString()}`;
            
            if (subscriptionData) {
                if (subscriptionData.plan) {
                    const planDisplay = subscriptionData.plan === 'year' ? 'Yearly' : 
                                      subscriptionData.plan === 'month' ? 'Monthly' : 
                                      subscriptionData.plan.toUpperCase();
                    details += `<br>Plan: ${planDisplay}`;
                }
                
                // Show cancellation or billing status
                console.log('üîç Subscription data for status display:', {
                    cancel_at_period_end: subscriptionData.cancel_at_period_end,
                    current_period_end: subscriptionData.current_period_end,
                    end_date: subscriptionData.end_date,
                    status: subscriptionData.status
                });
                
                if (subscriptionData.cancel_at_period_end) {
                    // Use end_date (which contains the current_period_end from Stripe)
                    const cancelDate = subscriptionData.end_date 
                        ? new Date(subscriptionData.end_date).toLocaleDateString()
                        : (subscriptionData.current_period_end ? new Date(subscriptionData.current_period_end).toLocaleDateString() : 'Unknown date');
                    details += `<br><strong style="color: #dc3545;">Your subscription will be cancelled on ${cancelDate}</strong>`;
                } else if (subscriptionData.current_period_end) {
                    const nextBillingDate = new Date(subscriptionData.current_period_end).toLocaleDateString();
                    details += `<br><strong style="color: #28a745;">Your subscription renews on ${nextBillingDate}</strong>`;
                } else {
                    // Fallback if no current_period_end is available
                    details += `<br><strong style="color: #666;">Next billing: Contact support</strong>`;
                }
            } else if (currentUser.subscription_expires_at) {
                const expiresDate = new Date(currentUser.subscription_expires_at).toLocaleDateString();
                if (currentUser.subscription_status === 'free') {
                    details += `<br><strong style="color: #dc3545;">Access ended: ${expiresDate}</strong>`;
                } else {
                    details += `<br>Expires: ${expiresDate}`;
                }
            }
            
            detailsDiv.innerHTML = details;
            
            // Show/hide action buttons
            updateSubscriptionActions();
        }

        function updateSubscriptionActions() {
            const manageBtn = document.getElementById('manage-subscription-btn');
            const cancelBtn = document.getElementById('cancel-subscription-btn');
            const reactivateBtn = document.getElementById('reactivate-subscription-btn');
            
            // Hide all buttons first
            manageBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            reactivateBtn.style.display = 'none';
            
            if (subscriptionData) {
                if (subscriptionData.status === 'active' && !subscriptionData.cancel_at_period_end) {
                    // Active subscription - show manage and cancel buttons
                    manageBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                } else if (subscriptionData.cancel_at_period_end) {
                    // Cancelling - show manage button only
                    manageBtn.style.display = 'inline-block';
                } else if (subscriptionData.status === 'canceled') {
                    // Cancelled - show reactivate button
                    reactivateBtn.style.display = 'inline-block';
                }
            } else if (currentUser.subscription_status === 'premium') {
                // Fallback for users without Stripe subscription data
                manageBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
            }
        }

        function setupEventListeners() {
            // Manage subscription button
            document.getElementById('manage-subscription-btn').addEventListener('click', manageSubscription);
            
            // Cancel subscription button
            document.getElementById('cancel-subscription-btn').addEventListener('click', cancelSubscription);
            
            // Reactivate subscription button
            document.getElementById('reactivate-subscription-btn').addEventListener('click', reactivateSubscription);
        }

        // Removed updatePlanButtons - no longer needed without pricing cards

        async function manageSubscription() {
            try {
                const response = await authManager.apiRequest('/api/stripe/create-portal-session', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.location.href = data.url;
                } else {
                    const error = await response.json();
                    console.error('Portal session error:', error);
                    
                    if (error.error === 'PORTAL_NOT_CONFIGURED') {
                        showErrorMessage('Customer Portal is not configured yet. You can:\n\n‚Ä¢ Cancel subscription using the "Cancel Subscription" button\n‚Ä¢ Change billing cycle using the options below\n‚Ä¢ Contact support for other changes');
                    } else {
                        showErrorMessage('Failed to open subscription management: ' + error.message);
                    }
                }
            } catch (error) {
                console.error('Error opening subscription management:', error);
                showErrorMessage('Failed to open subscription management. Please try again.');
            }
        }


        async function cancelSubscription() {
            // Check if user has a Stripe subscription
            if (!subscriptionData) {
                showErrorMessage('No active subscription found to cancel.');
                return;
            }

            // Create a more user-friendly confirmation dialog
            const confirmed = await showConfirmDialog(
                'Cancel Subscription',
                'Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your current billing period.',
                'Cancel Subscription',
                'Keep Subscription'
            );
            
            if (!confirmed) {
                return;
            }

            try {
                const response = await authManager.apiRequest('/api/stripe/cancel-subscription', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showSuccessMessage(data.message);
                    // Reload subscription data and update display
                    await loadSubscriptionData();
                    updateCurrentPlanDisplay();
                } else {
                    const error = await response.json();
                    console.error('Cancel subscription error:', error);
                    showErrorMessage('Failed to cancel subscription: ' + error.message);
                }
            } catch (error) {
                console.error('Error cancelling subscription:', error);
                showErrorMessage('Failed to cancel subscription. Please try again.');
            }
        }

        // Helper functions for better UI
        function showConfirmDialog(title, message, confirmText, cancelText) {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); display: flex; align-items: center;
                    justify-content: center; z-index: 1000;
                `;
                
                dialog.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center;">
                        <h3 style="margin-bottom: 15px; color: #333;">${title}</h3>
                        <p style="margin-bottom: 25px; color: #666; line-height: 1.5;">${message}</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="cancel-btn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ${cancelText}
                            </button>
                            <button id="confirm-btn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                dialog.querySelector('#cancel-btn').onclick = () => {
                    document.body.removeChild(dialog);
                    resolve(false);
                };
                
                dialog.querySelector('#confirm-btn').onclick = () => {
                    document.body.removeChild(dialog);
                    resolve(true);
                };
            });
        }

        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        function showErrorMessage(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            let backgroundColor;
            
            switch (type) {
                case 'success':
                    backgroundColor = '#28a745';
                    break;
                case 'error':
                    backgroundColor = '#dc3545';
                    break;
                case 'info':
                    backgroundColor = '#17a2b8';
                    break;
                default:
                    backgroundColor = '#6c757d';
            }
            
            messageDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; padding: 15px 20px;
                border-radius: 5px; color: white; z-index: 1000; max-width: 300px;
                background: ${backgroundColor};
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
            }, 5000);
        }

        async function reactivateSubscription() {
            if (!confirm('Are you sure you want to reactivate your subscription?')) {
                return;
            }

            try {
                // For reactivation, we'll redirect to the customer portal
                await manageSubscription();
            } catch (error) {
                console.error('Error reactivating subscription:', error);
                alert('Failed to reactivate subscription. Please try again.');
            }
        }

        async function syncSubscription(showMessages = true) {
            try {
                if (showMessages) {
                    showMessage('Syncing with Stripe...', 'info');
                }
                
                const response = await authManager.apiRequest('/api/stripe/sync-subscription', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (showMessages) {
                        showSuccessMessage(data.message);
                    }
                    
                    // Reload subscription data and update display
                    await loadSubscriptionData();
                    updateCurrentPlanDisplay();
                } else {
                    const error = await response.json();
                    console.error('Sync subscription error:', error);
                    if (showMessages) {
                        showErrorMessage('Failed to sync subscription: ' + error.message);
                    }
                }
            } catch (error) {
                console.error('Error syncing subscription:', error);
                if (showMessages) {
                    showErrorMessage('Failed to sync subscription. Please try again.');
                }
            }
        }
        
        // Removed selectPlan and updateSubscription - no longer needed without pricing cards
    </script>
</body>
</html>